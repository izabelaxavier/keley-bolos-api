<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Keley Bolos - Gestao</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #fdf2f7; padding: 20px; color: #333; }
    .container { max-width: 950px; margin: 0 auto; }

    .dashboard { display: flex; gap: 20px; margin-bottom: 25px; }

    /* CARD VERDE (Dinheiro na mao) */
    .card-total { background: linear-gradient(135deg, #198754, #146c43); color: white; padding: 20px; border-radius: 15px; flex: 1; text-align: center; box-shadow: 0 4px 15px rgba(25, 135, 84, 0.3); }
    .card-total h3 { margin: 0; font-size: 1.2em; opacity: 0.9; }
    .card-total span { font-size: 2.5em; font-weight: bold; }

    /* CARD AMARELO (A Receber) */
    .card-pendente { background: linear-gradient(135deg, #ffc107, #d39e00); color: white; padding: 20px; border-radius: 15px; flex: 1; text-align: center; box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3); }
    .card-pendente h3 { margin: 0; font-size: 1.2em; opacity: 0.9; color: #333; text-shadow: none; }
    .card-pendente span { font-size: 2.5em; font-weight: bold; color: #333; }

    .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
    h2 { color: #d63384; margin-top: 0; }

    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; color: #888; }
    input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    #divTaxa { display: none; background-color: #fff0f6; padding: 10px; border-radius: 8px; border: 1px dashed #d63384; margin-bottom: 15px; }

    .btn-salvar { background-color: #d63384; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; font-size: 16px; transition: 0.2s; }
    .btn-salvar:hover { background-color: #b02a6c; }

    .btn-acao { border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; margin-left: 3px; font-size: 0.9em; transition: 0.2s; }

    /* Cores dos Botoes */
    .btn-pdf { background-color: #4dabf7; color: white; }
    .btn-excluir { background-color: #adb5bd; color: white; }
    .btn-confirmar { background-color: #28a745; color: white; }
    .btn-cancelar { background-color: #dc3545; color: white; }
    .btn-reativar { background-color: #fd7e14; color: white; }

    table { width: 100%; border-collapse: collapse; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    th { background-color: #d63384; color: white; padding: 15px; text-align: left; }
    td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
    .total { color: #28a745; font-weight: bold; }
    .obs { color: #999; font-size: 0.85em; font-style: italic; }

    /* ESTILOS DE STATUS */
    .status-badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; white-space: nowrap; }
    .status-AGUARDANDO_PAGAMENTO { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
    .status-CONCLUIDO { background-color: #d4edda; color: #155724; }
    .status-CANCELADO { background-color: #f8d7da; color: #721c24; text-decoration: line-through; opacity: 0.7; }

    tr.row-CANCELADO td { color: #aaa; }
    tr.row-CANCELADO .total { color: #aaa; text-decoration: line-through; }
  </style>
</head>
<body>

<div class="container">
  <div class="dashboard">
    <div class="card-total">
      <h3>üí∞ Caixa (Recebido)</h3>
      <span id="totalCaixa">R$ 0,00</span>
    </div>
    <div class="card-pendente">
      <h3>‚è≥ A Receber</h3>
      <span id="totalPendente">R$ 0,00</span>
    </div>
  </div>

  <div class="card">
    <h2>üç∞ Novo Pedido</h2>
    <div class="form-group"><label>Cliente:</label><input type="text" id="clienteNome" placeholder="Nome"></div>
    <div class="form-group"><label>Telefone:</label><input type="text" id="clienteTelefone" placeholder="Telefone"></div>
    <div class="form-group">
      <label>Forma de Pagamento:</label>
      <select id="formaPagamento" onchange="verificarPagamento()">
        <option value="Pix">Pix</option>
        <option value="Dinheiro">Dinheiro</option>
        <option value="Debito">Debito</option>
        <option value="Credito">Credito (Cartao)</option>
      </select>
    </div>
    <div id="divTaxa">
      <label>üí≥ Taxa da Maquininha (R$):</label>
      <input type="number" id="taxaMaquininha" value="0.00" step="0.10">
    </div>

    <div style="display: flex; gap: 10px;">
      <div class="form-group" style="flex: 2;">
        <label>Produto:</label>
        <select id="produtoSelect" onchange="atualizarPreco()">
          <option value="" data-preco="0">Selecione...</option>
        </select>
      </div>
      <div class="form-group" style="flex: 1;">
        <label>Preco Unit. (R$):</label>
        <input type="number" id="precoUnitario" step="0.01">
      </div>
      <div class="form-group" style="flex: 0.5;">
        <label>Qtd:</label>
        <input type="number" id="quantidade" value="1" min="1">
      </div>
    </div>
    <div class="form-group"><label>Obs:</label><input type="text" id="observacao"></div>
    <button class="btn-salvar" onclick="salvarPedido()">Salvar Pedido</button>
  </div>

  <h2>Pedidos Realizados</h2>
  <table id="tabela">
    <thead>
    <tr>
      <th>Status</th>
      <th>Cliente</th>
      <th>Itens</th>
      <th>Total</th>
      <th style="text-align: center; width: 180px;">Acoes</th>
    </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  let listaProdutos = [];

  fetch('/produtos').then(r => r.json()).then(produtos => {
    listaProdutos = produtos;
    let select = document.getElementById('produtoSelect');
    select.innerHTML = '<option value="" data-preco="0">Selecione...</option>';
    const unicos = [...new Map(produtos.map(item => [item.nome, item])).values()];
    unicos.forEach(p => select.innerHTML += `<option value="${p.id}">${p.nome}</option>`);
  });

  function verificarPagamento() {
    const tipo = document.getElementById('formaPagamento').value;
    const divTaxa = document.getElementById('divTaxa');
    // REMOVIDO ACENTO DA VERIFICACAO:
    if (tipo === 'Credito') {
      divTaxa.style.display = 'block';
      document.getElementById('taxaMaquininha').value = '';
    } else {
      divTaxa.style.display = 'none';
      document.getElementById('taxaMaquininha').value = '0';
    }
  }

  function atualizarPreco() {
    const id = document.getElementById('produtoSelect').value;
    const produto = listaProdutos.find(p => p.id == id);
    if(produto) document.getElementById('precoUnitario').value = produto.preco;
  }

  function carregarPedidos() {
    fetch('/pedidos').then(r => r.json()).then(pedidos => {
      const tabela = document.querySelector('#tabela tbody');
      tabela.innerHTML = '';

      let caixaReal = 0;   // Dinheiro na mao (CONCLUIDO)
      let aReceber = 0;    // Dinheiro esperando (AGUARDANDO)

      // Ordenar: Pendentes primeiro
      pedidos.sort((a, b) => {
        if (a.status === 'AGUARDANDO_PAGAMENTO') return -1;
        if (b.status === 'AGUARDANDO_PAGAMENTO') return 1;
        return 0;
      });

      pedidos.forEach(p => {
        // SOMA INTELIGENTE: S√≥ soma no Verde se for CONCLUIDO
        if (p.status === 'CONCLUIDO') {
          caixaReal += p.valorTotal;
        } else if (p.status === 'AGUARDANDO_PAGAMENTO') {
          aReceber += p.valorTotal;
        }

        let itens = p.itens.map(i => `<b>${i.quantidade}x</b> ${i.produto.nome} ${i.observacao ? '<span class="obs">('+i.observacao+')</span>' : ''}`).join('<br>');
        let total = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(p.valorTotal);

        let statusBadge = '';
        let botoes = '';

        if (p.status === 'AGUARDANDO_PAGAMENTO') {
          statusBadge = '<span class="status-badge status-AGUARDANDO_PAGAMENTO">üü° Aguardando Pagamento</span>';
          botoes = `
                    <button class="btn-acao btn-confirmar" onclick="mudarStatus(${p.id}, 'CONCLUIDO')" title="Confirmar Pagamento">‚úÖ</button>
                    <button class="btn-acao btn-cancelar" onclick="mudarStatus(${p.id}, 'CANCELADO')" title="Cliente Desistiu">‚ùå</button>
                    <button class="btn-acao btn-pdf" onclick="gerarPdf(${p.id})">üñ®Ô∏è</button>
                `;
        } else if (p.status === 'CONCLUIDO') {
          statusBadge = '<span class="status-badge status-CONCLUIDO">üü¢ Pago</span>';
          botoes = `
                    <button class="btn-acao btn-pdf" onclick="gerarPdf(${p.id})">üñ®Ô∏è</button>
                    <button class="btn-acao btn-excluir" onclick="excluirPedido(${p.id})" title="Apagar">üóëÔ∏è</button>
                `;
        } else if (p.status === 'CANCELADO') {
          statusBadge = '<span class="status-badge status-CANCELADO">üî¥ Cancelado</span>';
          botoes = `
                    <button class="btn-acao btn-reativar" onclick="mudarStatus(${p.id}, 'AGUARDANDO_PAGAMENTO')" title="Reativar Pedido">üîÑ</button>
                    <button class="btn-acao btn-excluir" onclick="excluirPedido(${p.id})" title="Apagar">üóëÔ∏è</button>
                `;
        }

        if (!p.status) p.status = 'AGUARDANDO_PAGAMENTO';

        tabela.innerHTML += `
                <tr class="row-${p.status}">
                    <td>${statusBadge}</td>
                    <td>${p.cliente.nome}<br><small>${p.cliente.telefone}</small><br><small>(${p.formaPagamento || 'Pix'})</small></td>
                    <td>${itens}</td>
                    <td class="total">${total}</td>
                    <td style="text-align: center;">${botoes}</td>
                </tr>`;
      });

      // ATUALIZA OS DOIS PLACARES
      document.getElementById('totalCaixa').innerText = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(caixaReal);
      document.getElementById('totalPendente').innerText = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(aReceber);
    });
  }

  function salvarPedido() {
    let taxa = document.getElementById('taxaMaquininha').value;
    if (!taxa) taxa = 0;

    const dados = {
      cliente: {
        nome: document.getElementById('clienteNome').value,
        telefone: document.getElementById('clienteTelefone').value
      },
      formaPagamento: document.getElementById('formaPagamento').value,
      taxaMaquininha: taxa,
      itens: [{
        produtoId: document.getElementById('produtoSelect').value,
        quantidade: document.getElementById('quantidade').value,
        observacao: document.getElementById('observacao').value,
        precoPersonalizado: document.getElementById('precoUnitario').value
      }]
    };

    fetch('/pedidos', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(dados)
    }).then(r => {
      if(r.ok) {
        alert("Pedido Criado! üü°");
        carregarPedidos();
        document.getElementById('observacao').value = '';
        document.getElementById('taxaMaquininha').value = '0';
        document.getElementById('formaPagamento').value = 'Pix';
        verificarPagamento();
      }
      else alert("Erro ao salvar.");
    });
  }

  function mudarStatus(id, novoStatus) {
    fetch(`/pedidos/${id}/status`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(novoStatus)
    }).then(r => {
      if(r.ok) carregarPedidos();
    });
  }

  function excluirPedido(id) {
    if(confirm('Tem certeza? Isso apaga para sempre.')) {
      fetch(`/pedidos/${id}`, { method: 'DELETE' }).then(r => { if(r.ok) carregarPedidos(); });
    }
  }

  function gerarPdf(id) {
    window.open(`/pedidos/${id}/pdf`, '_blank');
  }

  carregarPedidos();
</script>
</body>
</html>