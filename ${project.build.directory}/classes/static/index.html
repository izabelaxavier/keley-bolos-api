<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Keley Bolos - Gest√£o</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #fdf2f7; padding: 20px; color: #333; margin: 0; }
    .container { max-width: 900px; margin: 0 auto; display: none; }
    #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fdf2f7; display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .login-card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 320px; text-align: center; }
    .login-card h2 { color: #d63384; margin-bottom: 25px; }
    #areaDona { display: none; }
    .dashboard { display: flex; gap: 20px; margin-bottom: 25px; }
    .card-total { background: linear-gradient(135deg, #198754, #146c43); color: white; padding: 20px; border-radius: 15px; flex: 1; text-align: center; }
    .card-pendente { background: linear-gradient(135deg, #ffc107, #d39e00); color: white; padding: 20px; border-radius: 15px; flex: 1; text-align: center; }
    .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
    h2 { color: #d63384; border-bottom: 2px solid #fce4ec; padding-bottom: 10px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; color: #666; }
    input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
    #divTaxa { display: none; background-color: #fff0f6; padding: 15px; border-radius: 10px; border: 1px dashed #d63384; margin-bottom: 15px; }
    .btn-salvar { background-color: #d63384; color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: bold; font-size: 16px; }
    .btn-acao { border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }
    .btn-confirmar { background-color: #28a745; color: white; }
    .btn-pdf { background-color: #4dabf7; color: white; }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 15px; overflow: hidden; }
    th { background-color: #d63384; color: white; padding: 15px; text-align: left; }
    td { padding: 15px; border-bottom: 1px solid #f8f9fa; }
    .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
    .status-AGUARDANDO_PAGAMENTO { background-color: #fff3cd; color: #856404; }
    .status-CONCLUIDO { background-color: #d4edda; color: #155724; }
  </style>
</head>
<body>

<div id="loginOverlay">
  <div class="login-card">
    <h2>üç∞ Keley Bolos</h2>
    <div class="form-group"><label>Usu√°rio:</label><input type="text" id="loginUser"></div>
    <div class="form-group"><label>Senha:</label><input type="password" id="loginSenha"></div>
    <button class="btn-salvar" onclick="realizarLogin()">Entrar</button>
  </div>
</div>

<div class="container" id="mainContent">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <span id="boasVindas" style="font-size: 18px; color: #d63384;"></span>
    <button onclick="location.reload()" style="background: none; border: 1px solid #d63384; color: #d63384; padding: 6px 12px; border-radius: 8px; cursor: pointer;">Sair</button>
  </div>

  <div id="areaDona">
    <div class="dashboard">
      <div class="card-total"><h3>üí∞ Caixa</h3><span id="totalCaixa">R$ 0,00</span></div>
      <div class="card-pendente"><h3>‚è≥ A Receber</h3><span id="totalPendente">R$ 0,00</span></div>
    </div>
    <div class="card"><h2> Resumo de Vendas</h2><div style="height: 200px;"><canvas id="graficoVendas"></canvas></div></div>
  </div>

  <div class="card">
    <h2>üç∞ Novo Pedido</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
      <div class="form-group"><label>Cliente:</label><input type="text" id="clienteNome"></div>
      <div class="form-group"><label>Telefone:</label><input type="text" id="clienteTelefone"></div>
    </div>
    <div class="form-group">
      <label>Pagamento:</label>
      <select id="formaPagamento" onchange="verificarPagamento()">
        <option value="Pix">Pix</option>
        <option value="Dinheiro">Dinheiro</option>
        <option value="Debito">D√©bito</option>
        <option value="Credito">Cr√©dito</option>
      </select>
    </div>
    <div id="divTaxa"><label>Taxa Cart√£o (R$):</label><input type="number" id="taxaMaquininha" value="0.00" step="0.01"></div>
    <div style="display: flex; gap: 10px; align-items: flex-end;">
      <div class="form-group" style="flex: 2;"><label>Produto:</label><select id="produtoSelect" onchange="atualizarPreco()"></select></div>
      <div class="form-group" style="flex: 1;"><label>Pre√ßo:</label><input type="number" id="precoUnitario" step="0.01"></div>
      <div class="form-group" style="flex: 0.5;"><label>Qtd:</label><input type="number" id="quantidade" value="1"></div>
    </div>
    <div class="form-group"><label>Observa√ß√£o:</label><input type="text" id="observacao"></div>
    <button class="btn-salvar" onclick="salvarPedido()">Salvar Pedido</button>
  </div>

  <h2>üìã Pedidos</h2>
  <table id="tabela">
    <thead><tr><th>Status</th><th>Cliente</th><th>Total</th><th style="text-align: center;">A√ß√µes</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script>
  let perfilUsuario = '';
  let meuGrafico = null;

  function realizarLogin() {
    const login = document.getElementById('loginUser').value;
    const senha = document.getElementById('loginSenha').value;
    fetch('/auth/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ login, senha }) })
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(u => {
        perfilUsuario = u.cargo;
        document.getElementById('boasVindas').innerHTML = `Ol√°, <b>${u.nome}</b>!`;
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        if(perfilUsuario === 'DONA') document.getElementById('areaDona').style.display = 'block';
        carregarProdutos(); carregarPedidos();
    }).catch(() => alert("Login inv√°lido!"));
  }

  function carregarProdutos() {
    fetch('/produtos').then(r => r.json()).then(pros => {
        let s = document.getElementById('produtoSelect');
        s.innerHTML = '<option value="">Selecione...</option>';
        pros.forEach(p => s.innerHTML += `<option value="${p.id}" data-preco="${p.preco}">${p.nome}</option>`);
    });
  }

  function atualizarPreco() {
    const s = document.getElementById('produtoSelect');
    document.getElementById('precoUnitario').value = s.options[s.selectedIndex].getAttribute('data-preco') || 0;
  }

  function verificarPagamento() {
    document.getElementById('divTaxa').style.display = (document.getElementById('formaPagamento').value === 'Credito') ? 'block' : 'none';
  }

  function salvarPedido() {
    const pId = document.getElementById('produtoSelect').value;
    if(!pId) return alert("Selecione o produto!");

    const dados = {
      cliente: { nome: document.getElementById('clienteNome').value, telefone: document.getElementById('clienteTelefone').value },
      formaPagamento: document.getElementById('formaPagamento').value,
      taxaMaquininha: parseFloat(document.getElementById('taxaMaquininha').value || 0),
      itens: [{
        produtoId: parseInt(pId),
        quantidade: parseInt(document.getElementById('quantidade').value),
        precoPersonalizado: parseFloat(document.getElementById('precoUnitario').value),
        observacao: document.getElementById('observacao').value
      }]
    };

    fetch('/pedidos', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(dados) })
    .then(r => r.ok ? (alert("Salvo!"), limparCampos(), carregarPedidos()) : alert("Erro ao salvar! Verifique os campos."))
    .catch(() => alert("Erro de conex√£o!"));
  }

  function carregarPedidos() {
    fetch('/pedidos').then(r => r.json()).then(peds => {
      const tb = document.querySelector('#tabela tbody');
      tb.innerHTML = '';
      let cx = 0, pe = 0, dg = { 'Pix': 0, 'Dinheiro': 0, 'Cart√£o': 0 };
      peds.forEach(p => {
        if (p.status === 'CONCLUIDO') {
            cx += p.valorTotal;
            let f = (p.formaPagamento === 'Credito' || p.formaPagamento === 'Debito') ? 'Cart√£o' : p.formaPagamento;
            if(dg[f] !== undefined) dg[f] += p.valorTotal;
        } else pe += p.valorTotal;

        let bt = p.status === 'AGUARDANDO_PAGAMENTO' ?
            `<button class="btn-confirmar btn-acao" onclick="mudarStatus(${p.id}, 'CONCLUIDO')">‚úÖ Pagar</button>` :
            `<button class="btn-pdf btn-acao" onclick="window.open('/pedidos/${p.id}/pdf', '_blank')">üñ®Ô∏è PDF</button>`;

        tb.innerHTML += `<tr><td><span class="status-badge status-${p.status}">${p.status.replace('_', ' ')}</span></td><td>${p.cliente.nome}</td><td>R$ ${p.valorTotal.toFixed(2)}</td><td style="text-align: center;">${bt}</td></tr>`;
      });
      if(perfilUsuario === 'DONA') {
        document.getElementById('totalCaixa').innerText = `R$ ${cx.toFixed(2)}`;
        document.getElementById('totalPendente').innerText = `R$ ${pe.toFixed(2)}`;
        renderizarGrafico(dg);
      }
    });
  }

  function mudarStatus(id, st) {
    fetch(`/pedidos/${id}/status`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(st) }).then(() => carregarPedidos());
  }

  function renderizarGrafico(d) {
    const c = document.getElementById('graficoVendas').getContext('2d');
    if (meuGrafico) meuGrafico.destroy();
    meuGrafico = new Chart(c, { type: 'doughnut', data: { labels: Object.keys(d), datasets: [{ data: Object.values(d), backgroundColor: ['#d63384', '#198754', '#4dabf7'] }] }, options: { maintainAspectRatio: false, animation: false } });
  }

  function limparCampos() {
    document.getElementById('clienteNome').value = ''; document.getElementById('clienteTelefone').value = '';
    document.getElementById('observacao').value = ''; document.getElementById('produtoSelect').value = '';
    document.getElementById('precoUnitario').value = ''; document.getElementById('taxaMaquininha').value = '0.00';
  }
</script>
</body>
</html>